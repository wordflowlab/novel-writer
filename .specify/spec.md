# Novel Writer Spec - AI 小说创作命令规范

本文件定义了 Novel Writer 支持的所有斜杠命令。
在 Claude Code、Cursor 或其他 AI 助手中使用这些命令进行小说创作。

## /chapters

---
description: 将章节规划分解为具体的写作任务
scripts:
  sh: .specify/scripts/bash/generate-tasks.sh
  ps: .specify/scripts/powershell/generate-tasks.ps1
---

**重要**：生成日期时，请先运行 `date '+%Y-%m-%d'` 获取当前系统日期，不要手动生成或猜测日期。

基于章节规划生成可执行的写作任务：

1. 运行脚本 `{SCRIPT}` 检查前置条件
2. 加载章节规划 `stories/*/outline.md`
3. 生成任务列表，包括：
   - **章节写作任务**：每章的具体写作任务
   - **角色完善任务**：深化角色设定
   - **世界观补充**：完善世界观细节
   - **修订任务**：已完成章节的修改
4. 按优先级排序任务：
   - 高优先级：开篇章节、主要角色设定
   - 中优先级：正常章节推进
   - 低优先级：补充设定、修订润色
5. 将任务写入 `stories/*/tasks.md`
6. 生成写作进度追踪文件

任务管理：
- 每个任务应有明确的完成标准
- 标记依赖关系（如某章依赖角色设定）
- 估算每个任务的预计字数和时间
- 可以根据实际情况调整任务优先级

## /clarify

---
description: 通过针对性问答澄清故事大纲中的模糊点，确保创作方向明确
scripts:
  sh: .specify/scripts/bash/clarify-story.sh --json --paths-only
  ps: .specify/scripts/powershell/clarify-story.ps1 -Json -PathsOnly
---

用户输入可以直接提供或作为命令参数 - 你**必须**在继续之前考虑它（如果不为空）。

用户输入：
$ARGUMENTS

## 目标

检测并减少故事大纲中的歧义或缺失的决策点，通过交互式问答收集澄清信息，并将结果记录在故事文件中。

**注意**：此澄清流程应在 `/outline` 之前运行并完成。如果用户明确表示跳过澄清（例如，探索性创作），可以继续，但必须警告下游返工风险会增加。

## 执行步骤

### 1. 初始化检查

运行 `{SCRIPT}` 获取当前故事路径：
- 解析 JSON 获取 `STORY_PATH` 和 `STORY_NAME`
- 如果没有找到故事文件，提示用户先运行 `/story` 创建故事大纲
- 加载故事文件内容进行分析

### 2. 结构化歧义扫描

对故事大纲进行全面扫描，评估每个类别的清晰度（清晰/部分清晰/缺失）：

**创作定位**
- 目标读者群体（年龄段、性别倾向、阅读层次）
- 作品定位（商业爽文/严肃文学/类型小说）
- 预期规模（短篇3-5万/中篇10-20万/长篇50万+）

**世界观设定**
- 时代背景精确度（具体年份/朝代/架空程度）
- 世界规则（魔法体系/科技水平/社会制度）
- 地理范围（单一城市/多国/大陆/星际）

**角色设计**
- 主角成长曲线（废柴逆袭/天才型/稳扎稳打）
- 主角性格基调（热血/冷静/腹黑/圣母）
- 配角功能定位（推动剧情/情感支撑/对比反衬）
- 反派智商设定（降智反派/势均力敌/高维碾压）

**叙事策略**
- 视角选择（第一人称/第三人称限定/上帝视角）
- 时间线结构（线性叙事/倒叙插叙/多线并行）
- 叙事节奏（快节奏爽文/慢热铺垫/张弛有度）

**情节核心**
- 核心冲突类型（人vs人/人vs自然/人vs社会/人vs自我）
- 主线目标明确度（复仇/成长/拯救/探索）
- 结局倾向（大团圆/悲剧/开放式）

**风格基调**
- 文风选择（白话流畅/古风典雅/幽默诙谐/冷峻写实）
- 描写侧重（动作场面/心理描写/环境氛围/对话推进）
- 情感基调（热血激昂/压抑黑暗/温馨治愈/虐心催泪）

**创作约束**
- 敏感内容处理（violence程度/情感尺度）
- 价值观导向（正能量/现实主义/批判性）
- 更新计划（日更/周更/月更）

对每个"部分清晰"或"缺失"的类别生成候选问题，除非：
- 澄清不会实质影响创作方向
- 信息更适合在章节规划阶段确定

### 3. 生成优先问题队列

内部生成最多5个优先澄清问题，应用以下约束：
- 整个会话最多5个问题
- 每个问题必须可以通过以下方式之一回答：
  * 多选题（2-5个互斥选项）
  * 简答题（限制5个词以内）
- 只包含对创作方向有实质影响的问题
- 确保类别覆盖平衡，优先高影响领域
- 如果超过5个类别需要澄清，选择（影响力×不确定性）最高的5个

### 4. 顺序问答循环

**一次展示一个问题**

多选题格式：
```markdown
| 选项 | 说明 |
|------|------|
| A | 选项A的详细说明 |
| B | 选项B的详细说明 |
| C | 选项C的详细说明 |
```

简答题格式：
```
请简要回答（5个词以内）：_______
```

**处理用户回答**
- 验证答案有效性
- 如有歧义，请求快速澄清
- 记录答案并继续下一个问题

**停止条件**
- 所有关键歧义已解决
- 用户示意完成（"好了"、"够了"、"不用了"）
- 已达到5个问题上限

### 5. 整合澄清结果

每个接受的答案后立即：

**首次整合时**
- 在故事大纲中创建 `## 澄清记录` 章节（如不存在）
- 添加 `### 澄清会话 [日期]` 子标题

**记录格式**
```markdown
- 问：[问题内容] → 答：[用户答案]
```

**更新相关章节**
根据澄清内容更新故事大纲的对应部分：
- 创作定位 → 更新故事概述
- 世界观 → 更新世界观设定
- 角色 → 更新角色设定
- 叙事策略 → 添加到创作说明
- 风格基调 → 添加到风格指南

### 6. 验证与保存

每次更新后验证：
- 澄清记录完整性
- 没有遗留的模糊标记被新答案解决
- 没有矛盾的陈述
- Markdown 格式正确

将更新后的内容写回故事文件。

### 7. 完成报告

报告包含：
- 提问和回答的问题数量
- 更新的故事文件路径
- 触及的章节列表
- 覆盖率总结表：

| 类别 | 状态 |
|------|------|
| 创作定位 | ✅ 已澄清 |
| 世界观设定 | ✅ 已澄清 |
| 角色设计 | ⏸ 延迟到规划 |
| ... | ... |

- 建议的下一步命令（通常是 `/outline`）

## 行为规则

- 如果没有发现有意义的歧义，回应："未检测到需要立即澄清的关键歧义。"
- 如果故事文件缺失，指导用户先运行 `/story`
- 不超过5个问题的总限制
- 避免询问纯技术写作细节
- 尊重用户的提前终止信号
- 如果未提问就达到完全覆盖，输出简洁的覆盖总结

## 小说创作特定考虑

- **类型惯例**：不同类型（玄幻、都市、历史）有不同的重点
- **读者预期**：商业作品vs文学作品的不同标准
- **文化敏感**：某些题材需要特别谨慎
- **系列规划**：是否为系列作品会影响很多决策

优先级上下文：{ARGS}

## /expert

---
description: 专家模式 - 获取专业写作指导
---

# 专家模式

根据用户输入执行相应操作：

## 1. 列出可用专家（无参数时）

如果用户输入 `/expert` 不带参数，显示所有可用专家：

### 核心专家
- **plot** - 剧情结构专家
  - 精通三幕、英雄之旅、故事圈等叙事结构
  - 分析情节问题、优化节奏、设计冲突升级

- **character** - 人物塑造专家
  - 人物弧光设计、动机分析、性格塑造
  - 对话优化、声音区分、关系构建

- **world** - 世界观设计专家
  - 世界观构建、设定一致性、文化背景
  - 规则体系、历史脉络、地理环境

- **style** - 文风语言专家
  - 叙述技巧、修辞手法、语言风格
  - 文风统一、氛围营造、节奏把控

### 插件专家
扫描 `plugins/` 目录，如果存在带有专家配置的插件，列出：
- 检查每个插件目录下的 `config.yaml`
- 如果包含 `experts` 字段，显示专家信息

使用示例：`/expert plot` 激活剧情结构专家

## 2. 激活专家模式

用户输入：`/expert <type>` （如 `/expert plot`）

### 执行步骤：
1. **确认专家类型**
   - 核心专家：读取 `experts/core/<type>.md`
   - 插件专家：读取对应插件的专家文件

2. **加载专家配置**
   读取专家定义文件，获取：
   - 身份定位
   - 专业领域
   - 工作方式
   - 分析框架

3. **进入专家模式**
   ```
   ✨ 已激活【<专家名称>】模式

   [显示专家的自我介绍]

   我现在会从专业角度为您提供 <领域> 方面的深度指导。
   有什么可以帮助您的吗？
   ```

4. **模式特征**
   - 保持专家视角和专业术语
   - 提供深度分析而非快速答案
   - 引用相关理论和方法论
   - 主动提出诊断性问题

## 3. 专家模式行为准则

进入专家模式后：
- **保持专业身份**：始终以该领域专家的视角交流
- **深度优先**：提供详细分析而非简单建议
- **理论支撑**：引用相关专业理论和框架
- **主动引导**：通过提问帮助用户深入思考
- **持续模式**：直到用户使用其他 `/` 命令才退出

## 4. 退出专家模式

当用户使用任何其他 `/` 命令时：
1. 自动退出专家模式
2. 执行新命令
3. 回到正常交互模式

无需显式退出命令，保持使用流畅性。

## 5. 错误处理

- 如果指定的专家不存在：
  ```
  未找到专家类型：<type>
  可用的专家有：plot, character, world, style
  使用 /expert 查看所有可用专家
  ```

- 如果专家文件读取失败：
  ```
  专家配置加载失败，请检查文件是否存在：
  experts/core/<type>.md
  ```

## /method

---
description: 智能写作方法助手 - 引导选择最适合的写作方法
sh: .specify/scripts/bash/method.sh
scripts:
  init: .specify/scripts/bash/method.sh
---

# 智能写作方法助手

这个命令帮助你通过引导式对话选择最适合的写作方法。

## 使用方式

在 AI 助手中输入 `/method`，AI 会通过对话了解你的需求，推荐合适的方法供你选择。

## AI 执行指南

当用户输入 `/method` 时，按以下步骤执行：

### 第一步：友好问候并收集信息

开始对话：
"你好！我来帮你选择最适合的写作方法。先聊聊你的故事设想吧，你想写什么类型的故事呢？"

通过2-3轮自然对话了解：
1. **故事类型**（奇幻/科幻/言情/悬疑/现实/历史等）
2. **预计长度**（几万字/几十万字/百万字以上）
3. **目标读者**（儿童/青少年/成人/大众）
4. **创作重点**（情节驱动/角色驱动/主题探讨）
5. **其他特点**（多线叙事/单线/群像/个人成长等）

### 第二步：分析并生成推荐

根据收集的信息，使用以下规则推荐：

#### 推荐规则表

| 条件 | 推荐方法 | 推荐理由 |
|------|----------|----------|
| 长度 < 5万字 | 皮克斯公式 | 简洁有力，适合短篇 |
| 奇幻/冒险 + 成长主题 | 英雄之旅 | 完美匹配成长型冒险故事 |
| 悬疑/惊悚 + 快节奏 | 七点结构 | 节奏紧凑，悬念迭起 |
| 角色驱动 + 心理深度 | 故事圈 | 强调内在变化和循环 |
| 通用/现实 + 中长篇 | 三幕结构 | 经典结构，适应性强 |
| 系统化写作 + 详细规划 | 雪花十步 | 从简到繁，层层深入，适合细致规划 |
| 新手作者 + 需要指导 | 雪花十步 | 步骤清晰，易于掌控节奏 |
| 长度 > 100万字 | 混合方法 | 需要多层次结构支撑 |
| 多线叙事 | 混合方法 | 不同线索用不同方法 |

### 第三步：展示推荐选项

**重要**：必须生成带编号的选择列表，格式如下：

```
根据你的描述，我为你推荐以下写作方法：

【推荐方案】

1. ⭐ [主推方法] - 最佳选择（匹配度 XX%）
   适合理由：
   - [理由1]
   - [理由2]
   - [理由3]

2. [备选方法] - 备选方案（匹配度 XX%）
   适合理由：
   - [理由1]
   - [理由2]

3. 混合方法 - 高级选择
   - 主线：[方法1]
   - 支线：[方法2]
   - 适合复杂故事结构

请输入数字选择（1/2/3），或输入 0 重新评估：
```

### 第四步：处理用户选择并更新配置

等待用户输入数字后：

1. 如果选择 1/2/3：
   - 确认选择："好的，你选择了 [方法名]"
   - **重要：使用 Edit 工具更新 `.specify/config.json` 中的 `"method"` 字段**
   - 方法名对应关系：
     - 三幕结构 → "three-act"
     - 英雄之旅 → "hero-journey"
     - 故事圈 → "story-circle"
     - 七点结构 → "seven-point"
     - 皮克斯公式 → "pixar-formula"
     - 雪花十步 → "snowflake"
     - 混合方法 → "hybrid"
   - 提供使用建议

2. 如果选择 0：
   - 重新开始对话收集信息

3. 如果选择混合方法：
   - 进一步询问细节
   - 生成混合方案
   - 更新配置为 "hybrid"
   - 可选：在配置中添加 `"hybridScheme"` 字段记录具体方案

### 第五步：提供后续指导

选择确认后：
```
✅ 已为你设置 [方法名] 作为写作方法！

【使用建议】
- [具体建议1]
- [具体建议2]
- [具体建议3]

【下一步】
使用 /story 创建故事大纲时，系统会自动应用 [方法名] 的模板。
使用 /outline 规划章节时，会按照 [方法名] 的结构要求分配。

需要了解 [方法名] 的详细说明吗？（是/否）
```

## 完整对话示例

```
用户：/method

AI：你好！我来帮你选择最适合的写作方法。先聊聊你的故事设想吧，你想写什么类型的故事呢？

用户：我想写一个现代都市言情小说

AI：都市言情，很受欢迎的题材！大概准备写多长呢？是十几万字的中篇，还是几十万字的长篇？

用户：大概30万字左右

AI：明白了。你的目标读者主要是？另外，你更注重情节推进还是人物情感的细腻描写？

用户：主要是年轻女性读者，我想重点写感情发展和人物内心

AI：
根据你的描述，我为你推荐以下写作方法：

【推荐方案】

1. ⭐ 故事圈 - 最佳选择（匹配度 92%）
   适合理由：
   - 特别适合刻画角色内心变化
   - 8步循环完美展现感情发展
   - 30万字的节奏刚好合适

2. 三幕结构 - 备选方案（匹配度 75%）
   适合理由：
   - 经典结构，易于掌控
   - 适合都市言情的冲突设置

3. 混合方法 - 高级选择
   - 主线：三幕结构（掌控整体节奏）
   - 感情线：故事圈（深化情感描写）
   - 适合多条感情线交织

请输入数字选择（1/2/3），或输入 0 重新评估：

用户：1

AI：好的，你选择了故事圈方法！

[此时 AI 使用 Edit 工具更新 .specify/config.json 中的 "method": "story-circle"]

✅ 已为你设置"故事圈"作为写作方法！配置已更新。

【使用建议】
- 将感情发展分为8个阶段，每个阶段3-4万字
- 重点刻画女主从舒适区到改变的内心历程
- 利用循环结构制造"似曾相识又不同"的情感共鸣

【下一步】
使用 /story 创建故事大纲时，系统会自动应用故事圈的模板。
使用 /outline 规划章节时，会按照8步循环的结构要求分配。

需要了解故事圈的详细说明吗？（是/否）
```

## 注意事项

1. **必须生成选择列表** - 不要直接替用户决定
2. **对话要自然** - 像朋友聊天，不要机械问答
3. **推荐要有依据** - 解释为什么推荐这个方法
4. **尊重用户选择** - 即使不是最优也要支持
5. **记录选择结果** - 提醒会应用到后续创作

## /outline

---
description: 规划详细的章节结构和情节安排
scripts:
  sh: .specify/scripts/bash/setup-outline.sh
  ps: .specify/scripts/powershell/setup-outline.ps1
---

基于已创建的故事大纲，制定详细的章节规划：

## 智能方法应用

1. **读取项目配置**
   - 读取 `.specify/config.json` 文件
   - 获取 `"method"` 字段的值
   - 如果是 `"hybrid"`，查看是否有 `"hybridScheme"` 详细方案

2. **根据方法选择模板**
   - 根据配置的方法，应用对应的章节规划模板
   - 模板参考：`spec/presets/[method]/outline.md`

3. **智能章节分配**
   - 根据方法的节奏要求分配章节
   - 确保关键节点（如七点结构的中点）位置正确
   - 为混合方法协调不同层级的结构

## 创建章节规划

1. 运行脚本 `{SCRIPT}` 初始化章节规划文件

2. 加载故事大纲 `stories/*/story.md` 理解故事内容

3. **根据写作方法使用对应的规划模板**
   - 三幕结构：25%设置、50%对抗、25%解决
   - 英雄之旅：12个阶段的章节分配
   - 故事圈：8个步骤的循环安排
   - 七点结构：7个关键节点的精确定位
   - 皮克斯公式：6步公式的因果链条
   - 雪花十步：场景列表驱动的章节规划

4. **混合方法的特殊处理**
   - 如果配置中 `method` 为 `"hybrid"`
   - 查看 `hybridScheme` 中的具体方案
   - 主线按主要方法安排
   - 支线按次要方法规划
   - 章节内部按微观方法组织

5. 创建章节规划，包含：
   - **总体结构**：总章节数、每章字数、更新计划
   - **方法映射**：每章对应的方法节点
   - **卷/部划分**：如有多卷，划分各卷主题
   - **详细章节**：每章的主要事件、角色发展、情节功能
   - **节奏控制**：高潮分布、悬念设置、情感曲线

6. 将规划写入 `stories/*/outline.md`

7. 创建章节文件夹结构 `stories/*/chapters/`

## 方法特定的规划要点

### 三幕结构
- 第一幕末尾要有第一个转折点
- 第二幕中点要有重大转变
- 第三幕要紧凑有力

### 英雄之旅
- 明确标记每个阶段的章节范围
- 导师出现、考验、重生等关键时刻

### 故事圈
- 每个循环步骤的章节分配
- 需求→搜索→找到→付出→回归的完整循环

### 七点结构
- 精确定位7个关键节点的章节
- 确保收紧点真正增加压力

### 皮克斯公式
- 清晰的因果链条
- 每个"因此"都要推进故事

### 雪花十步
- 基于第8步的场景列表规划
- 每个场景明确POV角色和冲突
- 四个25%的结构平衡

规划原则：
- 每章应有明确的目标和冲突
- 注意节奏的张弛有度
- 伏笔和回收要标记清楚
- 高潮要合理分布，不能都挤在最后

## /plot-check

---
name: plot-check
description: 检查情节发展的一致性和连贯性
scripts:
  sh: .specify/scripts/bash/check-plot.sh
  ps: .specify/scripts/powershell/check-plot.ps1
---

# 检查情节发展

分析当前章节与大纲的对齐情况，验证情节发展的连贯性。

## 检查内容

1. **情节节点对齐** - 验证当前进度与大纲规划是否一致
2. **伏笔追踪** - 检查已埋设的伏笔和回收计划
3. **冲突发展** - 确认冲突升级符合预期节奏
4. **角色成长** - 验证角色发展与规划一致

## 使用方法

执行脚本 {SCRIPT}，将会：
- 读取 `spec/tracking/plot-tracker.json`
- 对比 `outline.md` 中的规划
- 分析已写章节内容
- 生成一致性报告

## 输出示例

```
✅ 情节发展检查报告
━━━━━━━━━━━━━━━━━━━━
📍 当前进度：第61章（第二卷）
📊 对齐状态：与大纲一致

⚠️ 待处理伏笔：
  - 青铜古镜的秘密（第2章埋设）
  - 东厂的真实目的（第9章埋设）

✓ 已完成节点：
  - 科举及第 ✓
  - 获得改革传承 ✓

→ 下一个节点：组建改革派系

💡 建议：第65章前需要引入新的冲突点
```

## 智能检查功能

1. **自动更新当前状态**
   - 读取最新写作进度 `stories/*/progress.json`
   - 更新 `plot-tracker.json` 的 currentState
   - 同步章节和位置信息

2. **关联数据检查**
   - 对比 `timeline.json` 确认时间连续性
   - 检查 `relationships.json` 中的冲突是否体现
   - 验证 `character-state.json` 中的角色位置

3. **智能建议**
   - 根据当前进度提醒即将到来的情节点
   - 建议合适的伏笔回收时机
   - 提示需要加强的冲突升级

## 数据同步

检查完成后自动：
- 更新 plot-tracker.json 的检查时间
- 记录发现的问题到 notes 字段
- 生成下一步行动建议


## /relations

---
name: relations
description: 管理和追踪角色关系变化
scripts:
  sh: .specify/scripts/bash/manage-relations.sh
  ps: .specify/scripts/powershell/manage-relations.ps1
---

# 角色关系管理

追踪和管理角色之间的关系动态，确保关系发展的合理性。

## 功能

1. **关系网络** - 维护角色之间的关系图谱
2. **关系变化** - 记录关系的演变历程
3. **派系管理** - 追踪各势力派系的对立与合作
4. **情感追踪** - 管理角色间的情感发展

## 使用方法

执行脚本 {SCRIPT} [操作] [参数]：
- `update` - 更新角色关系
- `show` - 显示关系网络
- `history` - 查看关系变化历史
- `check` - 验证关系逻辑

示例：
```
{SCRIPT} update 李中庸 allies 沈玉卿 --chapter 61 --note 初入翰林相助
# PowerShell:
{SCRIPT} -Command update -A 李中庸 -Relation allies -B 沈玉卿 -Chapter 61 -Note 初入翰林相助
```

## 数据存储

关系数据存储在 `spec/tracking/relationships.json`：
```json
{
  "characters": {
    "主角": {
      "盟友": ["角色A", "角色B"],
      "敌对": ["角色C"],
      "爱慕": ["角色D"],
      "未知": ["角色E"]
    }
  },
  "factions": {
    "改革派": ["主角", "角色A"],
    "保守派": ["角色C", "角色F"]
  }
}
```

## 输出示例

```
👥 角色关系网络
━━━━━━━━━━━━━━━━━━━━
主角：李中庸
├─ 💕 爱慕：沈玉卿
├─ 🤝 盟友：张居正（隐藏）
├─ 📚 导师：利玛窦
├─ ⚔️ 敌对：申时行派系
└─ 👁️ 监视：东厂

派系对立：
改革派 ←→ 保守派
东林党 ←→ 阉党

最近变化（第60章）：
- 沈玉卿：陌生人 → 相互吸引
- 张居正：未知 → 师承关系
```


## /story

---
description: 创建故事大纲，包括主题、角色、世界观等核心设定
scripts:
  sh: .specify/scripts/bash/create-new-story.sh --json "{ARGS}"
  ps: .specify/scripts/powershell/create-new-story.ps1 -Json "{ARGS}"
---

**重要**：生成日期时，请先运行 `date '+%Y-%m-%d'` 获取当前系统日期，不要手动生成或猜测日期。

根据提供的故事描述创建完整的故事大纲：

## 智能方法应用

1. **读取项目配置**
   - 先读取 `.specify/config.json` 文件
   - 获取 `"method"` 字段的值（如：three-act、hero-journey、story-circle 等）
   - 如果没有设置，提示用户先使用 `/method` 命令选择写作方法

2. **选择对应的模板**
   - 根据配置中的方法，使用对应的模板：
     - `three-act` → 三幕结构模板
     - `hero-journey` → 英雄之旅12阶段模板
     - `story-circle` → 故事圈8步模板
     - `seven-point` → 七点结构模板
     - `pixar-formula` → 皮克斯6步公式
     - `snowflake` → 雪花十步法模板
   - 模板参考位置：`spec/presets/[method]/story.md`

## 创建故事大纲

1. 运行脚本 `{SCRIPT}` 并解析 JSON 输出，获取 STORY_NAME 和 STORY_FILE
   **重要**：脚本只运行一次，JSON 输出会显示在终端

2. **根据选定方法使用对应模板**
   - 三幕结构：使用经典三幕模板
   - 英雄之旅：使用12阶段模板
   - 故事圈：使用8步循环模板
   - 七点结构：使用7个关键节点模板
   - 皮克斯公式：使用6步公式模板
   - 雪花十步：使用递进式十步构建模板

3. 使用模板结构将故事大纲写入 STORY_FILE，包含：
   - **故事概述**：一句话描述、核心冲突、主题思想
   - **角色设定**：主角和重要配角的详细设定
   - **世界观**：时代背景、地理环境、特殊规则
   - **情节大纲**：按选定方法组织

4. 报告完成，包含：
   - 故事名称和文件路径
   - 使用的写作方法
   - 方法特点提醒
   - 准备进入章节规划

创作要点：
- 聚焦于"是什么"和"为什么"，而非"如何写"
- 角色要有明确的动机和成长弧线
- 世界观设定要自洽且有特色
- 情节要有冲突和张力

## /style

---
description: 设定和优化小说创作风格，支持初始设定和外部建议整合
scripts:
  sh: .specify/scripts/bash/style-manager.sh
  ps: .specify/scripts/powershell/style-manager.ps1
---

## 命令模式

### 模式1：初始设定（默认）
`/style` 或 `/style init`

根据提供的创作风格描述，执行以下操作：

1. 运行脚本 `{SCRIPT} init` 创建或更新创作风格文件
2. 加载 `.specify/memory/writing-constitution.md` 模板，理解所需的章节
3. 根据用户描述填充以下内容：
   - 叙事视角（第一人称/第三人称等）
   - 文字风格（简洁明快/华丽优美等）
   - 创作原则（角色塑造、情节推进等）
   - 质量标准（字数要求、更新频率等）
4. 将创作准则写入 `.specify/memory/writing-constitution.md`
5. 报告完成状态，准备进入下一阶段

附加整合：若检测到 `.specify/memory/personal-voice.md`，在填充风格时参考其中的口头禅、句式与意象，保持个人表达一致性（不强制，避免过拟合）

### 模式2：整合外部建议 ⭐新功能
`/style refine [建议内容]`

智能整合来自其他AI（如Gemini、ChatGPT）的分析建议：

1. **解析建议格式**
   运行脚本 `{SCRIPT} refine` 分析输入内容
   - 自动识别JSON或Markdown格式
   - 提取建议类别和优先级
   - 验证建议完整性

2. **智能分类处理**
   根据建议类型更新对应文件：
   - **写作风格** → `.specify/memory/writing-constitution.md`
   - **角色优化** → `spec/knowledge/character-profiles.md`
   - **情节建议** → `spec/tracking/plot-tracker.json`
   - **世界观** → `spec/knowledge/world-setting.md`
   - **对话规范** → `spec/knowledge/character-voices.md`

3. **建议历史记录**
   - 创建/更新 `spec/knowledge/improvement-log.md`
   - 记录建议来源、日期、采纳状态
   - 生成版本对比报告

4. **冲突处理**
   - 标记与现有规范的冲突
   - 提供合并选项
   - 保留回滚能力

5. **生成整合报告**
   ```
   ✅ 建议整合完成
   - 更新规范：X项
   - 新增任务：Y个
   - 冲突处理：Z个
   详见 improvement-log.md
   ```

### 模式3：多源建议合并
`/style refine --merge [多个建议]`

当有多个AI提供建议时，智能合并处理：
- 识别一致性建议（优先执行）
- 标记冲突建议（人工决策）
- 权重计算和优先级排序

## 建议格式要求

### JSON格式（推荐）
```json
{
  "version": "1.0",
  "source": "AI名称",
  "suggestions": {
    "style": {...},
    "characters": {...},
    "plot": {...}
  }
}
```

### Markdown格式（备选）
```markdown
# 小说创作建议报告
## 写作风格建议 [优先级]
...
```

详细格式见：`docs/ai-suggestion-prompt-template.md`

## 注意事项
- 初始设定应在创作前期完成
- 建议整合建议每10章执行一次
- 保持个人风格，不盲目采纳所有建议
- 定期查看 improvement-log.md 追踪改进效果


## /timeline

---
name: timeline
description: 管理和验证故事时间线
scripts:
  sh: .specify/scripts/bash/check-timeline.sh
  ps: .specify/scripts/powershell/check-timeline.ps1
---

# 时间线管理

维护故事的时间轴，确保时间逻辑的一致性。

## 功能

1. **时间记录** - 追踪每个章节的时间点
2. **并行事件** - 管理同时发生的多线剧情
3. **历史对照** - 与真实历史事件对比（历史小说）
4. **逻辑验证** - 检查时间跨度的合理性

## 使用方法

执行脚本 {SCRIPT}，支持以下操作：
- `add` - 添加时间节点
- `check` - 验证时间连续性
- `show` - 显示时间线概览
- `sync` - 同步并行事件

## 时间线数据

时间线信息存储在 `spec/tracking/timeline.json` 中：
- 故事内时间（年/月/日）
- 章节对应关系
- 重要事件标记
- 时间跨度计算

## 示例输出

```
📅 故事时间线
━━━━━━━━━━━━━━━━━━━━
当前时间：万历三十年春

第1章  | 万历二十九年冬月 | 穿越事件
第4章  | 万历三十年正月   | 北上赴考
第6章  | 万历三十年二月   | 会试
第8章  | 万历三十年三月   | 殿试
第61章 | 万历三十年四月   | [待写]

⏱️ 时间跨度：5个月
🔄 并行事件：日本入侵朝鲜
```


## /track-init

---
name: track-init
description: 初始化追踪系统，基于故事大纲设置追踪数据
scripts:
  sh: .specify/scripts/bash/init-tracking.sh
  ps: .specify/scripts/powershell/init-tracking.ps1
---

# 初始化追踪系统

基于已创建的故事大纲和章节规划，初始化所有追踪数据文件。

## 使用时机

在完成 `/story` 和 `/outline` 之后，开始写作之前执行此命令。

## 初始化流程

1. **读取基础数据**
   - 读取 `stories/*/story.md` 获取故事设定
   - 读取 `stories/*/outline.md` 获取章节规划
   - 读取 `.specify/config.json` 获取写作方法

2. **初始化追踪文件**

   创建或更新 `spec/tracking/plot-tracker.json`：
   - 从大纲提取主线和支线
   - 标记关键情节节点
   - 设置伏笔追踪点

   创建或更新 `spec/tracking/timeline.json`：
   - 根据章节规划设置时间节点
   - 标记重要时间事件

   创建或更新 `spec/tracking/relationships.json`：
   - 从角色设定提取初始关系
   - 设置派系分组

   创建或更新 `spec/tracking/character-state.json`：
   - 初始化角色状态
   - 设置起始位置

3. **生成追踪报告**
   显示初始化结果，确认追踪系统就绪

## 智能关联

- 根据写作方法自动设置检查点
- 英雄之旅：12个阶段的追踪点
- 三幕结构：三幕转折点
- 七点结构：7个关键节点

追踪系统初始化后，后续写作会自动更新这些数据。

## /track

---
name: track
description: 综合追踪小说创作进度和内容
scripts:
  sh: .specify/scripts/bash/track-progress.sh
  ps: .specify/scripts/powershell/track-progress.ps1
---

# 综合进度追踪

全面展示小说创作的各项进度和状态。

## 追踪维度

1. **写作进度** - 字数、章节、完成率
2. **情节发展** - 主线进度、支线状态
3. **时间线** - 故事时间推进
4. **角色状态** - 角色发展和位置
5. **伏笔管理** - 埋设和回收状态

## 使用方法

执行脚本 {SCRIPT} [选项]：
- 无参数 - 显示完整追踪报告
- `--brief` - 显示简要信息
- `--plot` - 仅显示情节追踪
- `--stats` - 仅显示统计数据
- `--check` - **[增强]** 执行深度一致性检查（包含角色验证）
- `--fix` - **[新增]** 自动修复发现的简单问题

## 数据来源

整合多个追踪文件的信息：
- `progress.json` - 写作进度
- `spec/tracking/plot-tracker.json` - 情节追踪
- `spec/tracking/timeline.json` - 时间线
- `spec/tracking/relationships.json` - 关系网络
- `spec/tracking/character-state.json` - 角色状态
- `spec/tracking/validation-rules.json` - **[新增]** 验证规则（用于--check和--fix）

## 输出示例

```
📊 小说创作综合报告
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📖 《大明风华录》

✍️ 写作进度
  完成：60/240章 (25%)
  字数：162,000/800,000
  当前：第二卷《朝堂风云》

📍 情节状态
  主线：改革大业 [朝堂初入阶段]
  支线：感情线 [相互了解]

⏰ 时间线
  故事时间：万历三十年春
  时间跨度：5个月

👥 主要角色
  李中庸：翰林院编修 @北京
  沈玉卿：张居正义女 [活跃]

⚡ 待处理
  伏笔：3个未回收
  冲突：改革vs保守 [升级中]

✅ 一致性检查：通过
```

## 增强功能

### 数据一致性验证

基础检查（默认执行）：
- plot-tracker.json 与 outline.md 的一致性
- timeline.json 的时间逻辑
- relationships.json 的关系冲突
- character-state.json 的位置合理性

### 深度验证模式 (--check)

当使用 `--check` 参数时，执行程序化的深度验证：

#### 内部任务流程（自动执行）
```markdown
# Phase 1: 基础验证 [并行执行]
- [x] T001 [P] 执行情节一致性检查 (plot-check逻辑)
- [x] T002 [P] 执行时间线验证 (timeline逻辑)
- [x] T003 [P] 执行关系验证 (relations逻辑)
- [x] T004 [P] 执行世界观验证 (world-check逻辑)

# Phase 2: 角色深度验证
- [x] T005 加载validation-rules.json验证规则
- [x] T006 扫描所有章节中的角色名称
- [x] T007 对比character-state.json验证名称一致性
- [x] T008 检查称呼是否符合relationships.json
- [x] T009 验证角色行为是否符合人设

# Phase 3: 生成综合报告
- [x] T010 汇总所有验证结果
- [x] T011 标记问题严重程度
- [x] T012 生成修复建议
```

#### 验证报告示例
```
📊 深度验证报告
━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 通过项目: 15/18

❌ 发现问题 (3):
1. [高] 第3章: 主角名"李明"应为"李中庸"
2. [中] 第7章: 沈玉卿称呼错误，用了"师兄"
3. [低] 第12章: 时间线跳跃未说明

🔧 可自动修复: 2个
📝 需人工确认: 1个

运行 /track --fix 自动修复简单问题
```

### 自动修复模式 (--fix)

当使用 `--fix` 参数时，基于验证报告自动修复：

#### 自动修复范围
1. **角色名称错误** - 根据validation-rules.json自动替换
2. **固定称呼错误** - 自动修正为正确称呼
3. **简单拼写错误** - 修正明显的typo

#### 修复流程
```markdown
# 内部修复任务（自动执行）
- [x] F001 读取验证报告中的问题列表
- [x] F002 [P] 修复第3章角色名称错误
- [x] F003 [P] 修复第7章称呼错误
- [x] F004 生成修复报告
- [x] F005 更新追踪文件
```

#### 修复报告示例
```
🔧 自动修复报告
━━━━━━━━━━━━━━━━━━━
✅ 已修复: 2个问题
- 第3章: "李明" → "李中庸"
- 第7章: "师兄" → "公子"

⚠️ 需人工处理: 1个问题
- 第12章: 时间线跳跃需要补充说明

修复完成！建议重新运行 /track --check 验证
```

### 智能分析与建议

1. **进度分析**
   - 对比计划进度和实际进度
   - 预测完成时间
   - 识别写作瓶颈

2. **内容分析**
   - 伏笔覆盖率（已埋设/已回收）
   - 角色出场频率
   - 冲突强度曲线

3. **行动建议**
   根据分析结果提供：
   - 下一步写作重点
   - 需要处理的伏笔
   - 建议加强的关系线
   - 时间线调整建议

### 可视化报告

生成结构化报告：
```
📊 综合追踪报告
━━━━━━━━━━━━━━━━━━━━━━━━━━
[进度条] ████████░░░░░░░ 25%

🎯 下一步建议：
1. 第65章前回收"青铜古镜"伏笔
2. 加强主角与反派的正面冲突
3. 补充第二卷的时间线细节

⚠️ 需要关注：
- 角色B已5章未出场
- 支线剧情进度滞后
- 第45章的时间跳跃需要说明
```

### 数据导出

支持导出追踪数据为：
- Markdown 格式的完整报告
- JSON 格式的原始数据
- 可视化图表（关系图、时间轴）


## /world-check

---
name: world-check
description: 验证世界观设定的一致性
scripts:
  sh: .specify/scripts/bash/check-world.sh
---

# 世界观一致性检查

确保故事中的世界观设定保持前后一致，避免矛盾和冲突。

## 检查范围

1. **设定一致性** - 验证规则、法则、体系的一致
2. **地理逻辑** - 检查地点、距离、方位的合理性
3. **文化连贯** - 确保风俗、语言、传统的统一
4. **科技/魔法水平** - 验证能力范围和限制

## 使用方法

执行脚本 {SCRIPT}，将会：
- 扫描 `spec/knowledge/world-setting.md`
- 分析已写章节中的设定描述
- 对比查找矛盾和冲突
- 生成一致性报告

## 知识库结构

世界观设定存储在 `spec/knowledge/` 目录：
- `world-setting.md` - 核心世界观
- `locations.md` - 地点描述
- `culture.md` - 文化风俗
- `rules.md` - 特殊规则

## 输出示例

```
🌍 世界观一致性报告
━━━━━━━━━━━━━━━━━━━━
✅ 检查通过：23项
⚠️ 潜在问题：2项

⚠️ 发现的问题：
1. 第15章提到"三日路程"，但按地图应为五日
2. 第23章的官职名称与第3章不一致

📚 设定统计：
- 地点：15个
- 组织：8个
- 特殊规则：5条
- 专有名词：47个

💡 建议创建术语表以保持一致性
```

## /write

---
description: 执行具体的章节写作，AI 辅助创作内容
scripts:
  sh: .specify/scripts/bash/write-chapter.sh
  ps: .specify/scripts/powershell/write-chapter.ps1
---

执行章节写作任务：

1. 运行脚本 `{SCRIPT}` 确定要写作的章节
2. 加载相关文件：
   - 创作风格：`.specify/memory/writing-constitution.md`
   - 故事大纲：`stories/*/story.md`
   - 章节规划：`stories/*/outline.md`
   - 前文内容：`stories/*/chapters/` (如有)
   - **角色验证规则**：`spec/tracking/validation-rules.json` (如有)
   - **角色状态**：`spec/tracking/character-state.json`
   - **关系规则**：`spec/tracking/relationships.json`
   - **个人语料**：`memory/personal-voice.md`
   - **自然化表达**：`spec/knowledge/natural-expression.md`
   - **反AI检测**：`spec/presets/anti-ai-detection.md`

## 写作前验证提醒

**如果存在验证规则文件，执行以下检查**：
1. 显示主角正确名称和别名
2. 列出本章将出现的角色及其正确称呼
3. 提醒常见错误（从validation-rules.json的common_errors读取）

示例输出：
```
📝 写作提醒
━━━━━━━━━━━━━━━━━━━
主角：李中庸（中庸、李公子）
配角：沈玉卿 → 主角称呼为"公子"
⚠️ 避免使用：李明、张华、主角
```

3. **应用反AI检测策略**：
   - **词汇优化**：替换AI特征词为口语表达
   - **句法自然化**：长短句交错，加入口语特征
   - **认知模拟**：体现人类思维的不完美性
   - **缺陷植入**：适度的错别字和标点随意（每2000字1处）
   - **个性标记**：应用personal-voice.md的个人特征

4. 根据章节大纲创作内容：
   - **开场**：吸引读者，承接前文
   - **发展**：推进情节，深化人物
   - **转折**：制造冲突或悬念
   - **收尾**：适当收束，引出下文

5. 确保内容符合：
   - 设定的创作风格
   - 角色性格一致性
   - 世界观规则
   - 情节逻辑
   - **自然化要求**：避免过于完美的表达
6. **写作后快速验证**（如果存在validation-rules.json）：
   - 扫描生成内容中的角色名称
   - 检查是否有forbidden列表中的错误名称
   - 验证称呼是否符合relationships规则
   - 如发现问题，立即提示并建议修正

7. **AI检测自检**：
   - 检查是否有连续3句结构相似
   - 检查用词是否过于书面化
   - 确认有适度的口语化特征
   - 验证文本不过于完美

8. 将章节内容写入对应文件
9. 更新写作进度和任务状态

写作要点：
- 保持风格一致性
- 注意伏笔的埋设和回收
- 对话要符合角色身份
- 描写要有画面感
- 每章要有明确的推进作用
- **反AI要点**：
  - 自然化表达优于完美文字
  - 适度缺陷增加真实感
  - 个人特征贯穿全文

## 追踪数据自动更新

写作完成后，自动执行以下更新：

1. **更新情节追踪**
   - 更新 `spec/tracking/plot-tracker.json` 的当前章节
   - 标记完成的情节节点
   - 记录新增的伏笔

2. **更新时间线**
   - 提取章节中的时间信息
   - 更新 `spec/tracking/timeline.json`
   - 检查时间连续性

3. **更新角色关系**
   - 识别关系变化
   - 更新 `spec/tracking/relationships.json`
   - 记录关系演变历程

4. **更新角色状态**
   - 记录角色位置变化
   - 更新 `spec/tracking/character-state.json`
   - 追踪角色发展

5. **生成追踪提醒**
   ```
   ✅ 第N章写作完成，追踪数据已更新

   建议执行：
   - /plot-check 验证情节连贯性
   - /timeline 检查时间逻辑
   - /relations 确认关系变化
   - /track --check 批量验证最近章节（推荐每10章执行一次）
   ```

这样确保追踪数据始终与写作进度同步。

## 批量验证提醒

当完成多个章节后（建议每5-10章），运行：
```
/track --check   # 深度验证所有内容一致性
/track --fix     # 自动修复发现的简单问题
```

